#! /bin/bash
dateup () {
DATE=$(date "+%D, %r")
}
DIR=$(dirname -- "$( readlink -f -- "$0"; )";) #credit to phatblat on StackOverflow



#//Config File//
configinit () {
CONFIG=$DIR/usbackup.conf
PARAMS=$(grep -o USB_ID $CONFIG && grep -o USBMT $CONFIG && grep -o CPDIR $CONFIG && grep -o TIME $CONFIG)
PCHECK="$?" #0 = found, 1 = not found

if [[ -f "$CONFIG" ]]; then
    if [[ $PCHECK == 1 ]]; then
      dateup#! /bin/bash
dateup () {
DATE=$(date "+%D, %r")
}
DIR=$(dirname -- "$( readlink -f -- "$0"; )";) #credit to phatblat on StackOverflow



#//Config File//
configinit () {
CONFIG=$DIR/usbackup.conf
PARAMS=$(grep -o USB_ID $CONFIG && grep -o USBMT $CONFIG && grep -o CPDIR $CONFIG && grep -o TIME $CONFIG)
PCHECK="$?" #0 = found, 1 = not found

if [[ -f "$CONFIG" ]]; then
    if [[ $PCHECK == 1 ]]; then
      dateup
      echo "[$DATE] ERROR: $CONFIG configured improperly!" >> $DIR/usbackup.log
      echo "USBackup configuration file is empty or missing components, please run 'usbackup -C'"
      return 0
    fi
    source $CONFIG
    MTPT=$(fdisk -l | grep --after-context=4 $USB_ID | grep -oE '/dev/.{,4}' 2>/dev/null) #fetches mount from fdisk
    dateup
    echo "[$DATE] Config file loaded." >> $DIR/usbackup.log
else
    dateup
    echo "[$DATE] ERROR: $CONFIG is missing!" >> $DIR/usbackup.log
    echo "USBackup configuration file missing, please run 'usbackup -C'"
    return 0
fi
}

#//initialization//
#Check for desired USB Drive
usbinit () {
    fdisk -l | grep -qo $USB_ID
    usbstatus="$?" #0=dev detected, 1=not detected
}

usbcheck () {
until [[ $usbstatus == 0 ]]; do #Must pass check to continue init
    usbinit &>/dev/null #call function, suppress error output
    echo "checking for usb"
    sleep 10s
done

dateup
echo "[$DATE] USB found." >> $DIR/usbackup.log
}

#initialize network
ninit () {
    ip address show | grep -qwo NO-CARRIER
    nstatus="$?" #0=no connection, 1=connection
}
ninit #init var

#initialize USB
usbcreate () {
mount -o defaults,rw,uid=1000,gid=1000,umask=0002 $MTPT $USBMT #mount, make sure USB is labeled correctly before running
cp -a --no-preserve=ownership $CPDIR $USBMT #when USB is first plugged in, update with current files
dateup
echo "[$DATE] USB mounted, wrote updated files." >> $DIR/usbackup.log
}


#//User Input//
while getopts ":hCsur" flag; do
    case ${flag} in
        h)
        echo
        "Usage: usbackup [OPTION]
        Daemon program to automatically back up important files from a directory to a USB drive.

            -h  (help)          Displays this help message.
            -C  (configure)     Opens the configuration dialog (Recommended first!).
            -s  (status)        Displays the last 25 operations carried out by the program. (see $DIR/usbackup.log for more)
            -u  (unmount)       Signals usbackup to unmount the USB safely. USB will automatically be remounted when put back.
        For more info please see: (https://github.com/amiable-blight/amiable-blight.github.io/tree/main/Bash/USBackup)"
        ;;


        C)
        confconfig () {
        echo "1) Disk ID of USB drive to save to (use 'fdisk -l' to find the disk)"
        read USBUUID
        echo "2) USB Mountpoint (format: /media/your-USB-directory)"
            read USB_MOUNT
            mkdir $USBMT &>/dev/null
        echo "3) Directory to copy from (format: /mnt/your-drive/your-directory)"
            read USE_DIR
        echo "4) Interval for backups under normal operation (in minutes)"
            read INTERVAL
        echo "#//THIS PORTION OF THE CONFIG FILE WAS AUTOGENERATED BY THE CONFIGURE COMMAND AT $DATE//" >> $DIR/usbackup.conf
        echo "USB_ID=$USBUUID" >> $DIR/usbackup.conf
        echo "USBMT=$USB_MOUNT" >> $DIR/usbackup.conf
        echo "CPDIR=$USE_DIR" >> $DIR/usbackup.conf
        echo "TIME=$INTERVAL" >> $DIR/usbackup.conf
        echo "NOTE: When the config is changed, the old entry must manually be deleted at $DIR/usbackup.conf" | tee -a usbackup.conf
        echo "NOTE: If the configuration is changed after its initial setup, either restart or run 'usbackup -u' to re-initialize"
        dateup
        echo "[$DATE] NOTICE: Config file updated." | tee -a >> $DIR/usbackup.log
        }
        configinit
        echo "USBackup configuration dialog:"
        if [[ $PCHECK == 0 ]]; then
            echo "Configuration file is valid. Would you like to erase and start over? (y/n)"
            read YN
            if [[ $YN == y ]]; then
                echo "#//USBACKUP CONFIGURATION FILE//" > $DIR/usbackup.conf
                echo "#This config file is very barebones, but more features may be added in time." >> $DIR/usbackup.conf
                confconfig
                exit 0
            else
                echo "Configuration aborted."
                exit 0
            fi
        elif [[ $PCHECK == 1 ]]; then
            echo "#//USBACKUP CONFIGURATION FILE//" > $DIR/usbackup.conf
            echo "#This config file is very barebones, but more features may be added in time." >> $DIR/usbackup.conf
            confconfig
            exit 0
        fi
        ;;


        s)
        LINE=$(wc -l < $DIR/usbackup.log)
        SIZE=$(wc -c < $DIR/usbackup.log)
        tail -n 25 $DIR/usbackup.log
        echo "Last 25 log entries shown. Full log is located at '$DIR/usbackup.log'. Feel free to clear log from time to time."
        echo "Total entries: $LINE; Log file size: $(($SIZE / 1000)) kB"
        exit 0
        ;;


        u)
        configinit
        umount -f $MTPT
        dateup
        echo "[$DATE] USB manually unmounted." | tee -a $DIR/usbackup.log
        exit 0
        ;;

        :) echo "usbackup requires an argument. Try 'usbackup -h'"
            exit 0
        ;;
        ?) echo "Unknown paramater. Try 'usbackup -h'"
            exit 0
        ;;
    esac
done

#//Main Operation//
#Define functions
ncheck () {
until [[ $nstatus == 1 ]]; do #Do not proceed until network is obtained, already created a copy during init
    ninit
    sleep 10s
done

dateup
echo "[$DATE] Network found." >> $DIR/usbackup.log
functional
}

functional () {
    timer=0
    while :; do
            ninit
            usbinit
            if [ $nstatus == 1 -a $usbstatus == 0  ]; then
                sleep 1m
                ((timer++))
                if [[ $timer == $TIME ]]; then
                    ninit
                    if [[ $nstatus == 0 ]]; then noconnect & return 1; fi #worst case network check
                    usbinit
                    if [[ $usbstatus == 1 ]]; then nousb & return 1; fi #worst case USB check
                    dateup
                    echo "[$DATE] Time passed, writing to USB." >> $DIR/usbackup.log
                    cp -a --no-preserve=ownership $CPDIR $USBMT
                    timer=0
                fi
            fi
            if [[ $nstatus == 0 ]]; then
                noconnect &
                return 1
            elif [[ $usbstatus == 1 ]]; then
                nousb &
                return 1
            fi
    done
}

noconnect () {
    dateup
    echo "[$DATE] Network down, writing to USB." >> $DIR/usbackup.log
    cp -a --no-preserve=ownership $CPDIR $USBMT
    ncheck
}

nousb () {
    dateup
    echo "[$DATE] USB lost, stopping." | tee -a $DIR/usbackup.log
    usbcheck #waits until USB is found again
    usbcreate #remounts
    functional #goes back to normal function
}


#Actual program start
start () {
configinit #checks .conf file
usbinit &>/dev/null #init var, suppress error output
usbcheck #checks USB status
usbcreate #mounts USB
ncheck #starts loop
}

start #calls startup process

#//Current Issues//
#A lack of error log entries, even if it fails, it still says it did what was supposed to happen.

      echo "[$DATE] ERROR: $CONFIG configured improperly!" >> $DIR/usbackup.log
      echo "USBackup configuration file is empty or missing components, please run 'usbackup -C'"
      return 0
    fi
    source $CONFIG
    MTPT=$(fdisk -l | grep --after-context=4 $USB_ID | grep -oE '/dev/.{,4}' 2>/dev/null) #fetches mount from fdisk
    dateup
    echo "[$DATE] Config file loaded." >> $DIR/usbackup.log
else
    dateup
    echo "[$DATE] ERROR: $CONFIG is missing!" >> $DIR/usbackup.log
    echo "USBackup configuration file missing, please run 'usbackup -C'"
    return 0
fi
}

#//initialization//
#Check for desired USB Drive
usbinit () {
    fdisk -l | grep -qo $USB_ID
    usbstatus="$?" #0=dev detected, 1=not detected
}

usbcheck () {
until [[ $usbstatus == 0 ]]; do #Must pass check to continue init
    usbinit &>/dev/null #call function, suppress error output
    echo "checking for usb"
    sleep 10s
done

dateup
echo "[$DATE] USB found." >> $DIR/usbackup.log
}

#initialize network
ninit () {
    ip address show | grep -qwo NO-CARRIER
    nstatus="$?" #0=no connection, 1=connection
}
ninit #init var

#initialize USB
usbcreate () {
mount -o defaults,rw,uid=1000,gid=1000,umask=0002 $MTPT $USBMT #mount, make sure USB is labeled correctly before running
cp -a --no-preserve=ownership $CPDIR $USBMT #when USB is first plugged in, update with current files
dateup
echo "[$DATE] USB mounted, wrote updated files." >> $DIR/usbackup.log
}


#//User Input//
while getopts ":hCsur" flag; do
    case ${flag} in
        h)
        echo
        "Usage: usbackup [OPTION]
        Daemon program to automatically back up important files from a directory to a USB drive.

            -h  (help)          Displays this help message.
            -C  (configure)     Opens the configuration dialog (Recommended first!).
            -s  (status)        Displays the last 25 operations carried out by the program. (see $DIR/usbackup.log for more)
            -u  (unmount)       Signals usbackup to unmount the USB safely. USB will automatically be remounted when put back.
        For more info please see: (https://github.com/amiable-blight/amiable-blight.github.io/tree/main/Bash/USBackup)"
        ;;


        C)
        confconfig () {
        echo "1) Disk ID of USB drive to save to (use 'fdisk -l' to find the disk)"
        read USBUUID
        echo "2) USB Mountpoint (format: /media/your-USB-directory)"
            read USB_MOUNT
            mkdir $USBMT &>/dev/null
        echo "3) Directory to copy from (format: /mnt/your-drive/your-directory)"
            read USE_DIR
        echo "4) Interval for backups under normal operation (in minutes)"
            read INTERVAL
        echo "#//THIS PORTION OF THE CONFIG FILE WAS AUTOGENERATED BY THE CONFIGURE COMMAND AT $DATE//" >> $DIR/usbackup.conf
        echo "USB_ID=$USBUUID" >> $DIR/usbackup.conf
        echo "USBMT=$USB_MOUNT" >> $DIR/usbackup.conf
        echo "CPDIR=$USE_DIR" >> $DIR/usbackup.conf
        echo "TIME=$INTERVAL" >> $DIR/usbackup.conf
        echo "NOTE: When the config is changed, the old entry must manually be deleted at $DIR/usbackup.conf" | tee -a usbackup.conf
        echo "NOTE: If the configuration is changed after its initial setup, either restart or run 'usbackup -u' then 'usbackup -r' to re-initialize."
        dateup
        echo "[$DATE] NOTICE: Config file updated." | tee -a >> $DIR/usbackup.log
        }
        configinit
        echo "USBackup configuration dialog:"
        if [[ $PCHECK == 0 ]]; then
            echo "Configuration file is valid. Would you like to erase and start over? (y/n)"
            read YN
            if [[ $YN == y ]]; then
                echo "#//USBACKUP CONFIGURATION FILE//" > $DIR/usbackup.conf
                echo "#This config file is very barebones, but more features may be added in time." >> $DIR/usbackup.conf
                confconfig
            else
                echo "Configuration aborted."
                exit 0
            fi
        elif [[ $PCHECK == 1 ]]; then
            echo "#//USBACKUP CONFIGURATION FILE//" > $DIR/usbackup.conf
            echo "#This config file is very barebones, but more features may be added in time." >> $DIR/usbackup.conf
            confconfig
        fi
        ;;


        s)
        LINE=$(wc -l < $DIR/usbackup.log)
        SIZE=$(wc -c < $DIR/usbackup.log)
        tail -n 25 $DIR/usbackup.log
        echo "Last 25 log entries shown. Full log is located at '$DIR/usbackup.log'. Feel free to clear log from time to time."
        echo "Total entries: $LINE; Log file size: $(($SIZE / 1000)) kB"
        exit 0
        ;;


        u)
        configinit
        umount -f $MTPT
        dateup
        echo "[$DATE] USB manually unmounted." | tee -a $DIR/usbackup.log
        exit 0
        ;;

        :) echo "usbackup requires an argument. Try 'usbackup -h'"
            exit 0
        ;;
        ?) echo "Unknown paramater. Try 'usbackup -h'"
            exit 0
        ;;
    esac
done

#//Main Operation//
#Define functions
ncheck () {
until [[ $nstatus == 1 ]]; do #Do not proceed until network is obtained, already created a copy during init
    ninit
    sleep 10s
done

dateup
echo "[$DATE] Network found." >> $DIR/usbackup.log
functional
}

functional () {
    timer=0
    while :; do
            ninit
            usbinit
            if [ $nstatus == 1 -a $usbstatus == 0  ]; then
                sleep 1m
                ((timer++))
                if [[ $timer == $TIME ]]; then
                    ninit
                    if [[ $nstatus == 0 ]]; then noconnect & return 1; fi #worst case network check
                    usbinit
                    if [[ $usbstatus == 1 ]]; then nousb & return 1; fi #worst case USB check
                    dateup
                    echo "[$DATE] Time passed, writing to USB." >> $DIR/usbackup.log
                    cp -a --no-preserve=ownership $CPDIR $USBMT
                    timer=0
                fi
            fi
            if [[ $nstatus == 0 ]]; then
                noconnect &
                return 1
            elif [[ $usbstatus == 1 ]]; then
                nousb &
                return 1
            fi
    done
}

noconnect () {
    dateup
    echo "[$DATE] Network down, writing to USB." >> $DIR/usbackup.log
    cp -a --no-preserve=ownership $CPDIR $USBMT
    ncheck
}

nousb () {
    dateup
    echo "[$DATE] USB lost, stopping." | tee -a $DIR/usbackup.log
    usbcheck #waits until USB is found again
    usbcreate #remounts
    functional #goes back to normal function
}


#Actual program start
start () {
configinit #checks .conf file
usbinit &>/dev/null #init var, suppress error output
usbcheck #checks USB status
usbcreate #mounts USB
ncheck #starts loop
}

start #calls startup process

#//Current Issues//
#A lack of error log entries, even if it fails, it still says it did what was supposed to happen.
